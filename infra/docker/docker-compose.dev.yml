# ==============================================================================
# AI Red Team Agent — Development Docker Compose Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# ==============================================================================

services:
  # --------------------------------------------------------------------------
  # PostgreSQL — Expose port for local tools (pgAdmin, DBeaver)
  # --------------------------------------------------------------------------
  postgres:
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: devpassword

  # --------------------------------------------------------------------------
  # Redis — No password in dev, expose port for redis-cli
  # --------------------------------------------------------------------------
  redis:
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"

  # --------------------------------------------------------------------------
  # Backend API — Hot reload, debug mode, mounted source
  # --------------------------------------------------------------------------
  api:
    build:
      context: ../../backend
      dockerfile: Dockerfile
      target: development
    command: >
      uvicorn app.main:app
      --host 0.0.0.0
      --port 8000
      --reload
      --reload-dir /app
      --log-level debug
    env_file:
      - ../env/.env.development
    environment:
      APP_ENV: development
      APP_DEBUG: "true"
      POSTGRES_HOST: postgres
      POSTGRES_PASSWORD: devpassword
      REDIS_HOST: redis
      DATABASE_URL: postgresql+asyncpg://postgres:devpassword@postgres:5432/ai_red_team
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      REDIS_URL: redis://redis:6379/1
    volumes:
      - ../../backend/app:/app/app:cached
      - ../../backend/tests:/app/tests:cached
    ports:
      - "8000:8000"

  # --------------------------------------------------------------------------
  # Celery Worker — Hot reload with watchfiles
  # --------------------------------------------------------------------------
  worker:
    build:
      context: ../../backend
      dockerfile: Dockerfile
      target: development
    command: >
      watchfiles --filter python
      "celery -A app.worker.celery_app worker --loglevel=debug --concurrency=2"
      /app/app
    env_file:
      - ../env/.env.development
    environment:
      APP_ENV: development
      APP_DEBUG: "true"
      POSTGRES_HOST: postgres
      POSTGRES_PASSWORD: devpassword
      REDIS_HOST: redis
      DATABASE_URL: postgresql+asyncpg://postgres:devpassword@postgres:5432/ai_red_team
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      REDIS_URL: redis://redis:6379/1
    volumes:
      - ../../backend/app:/app/app:cached

  # --------------------------------------------------------------------------
  # Frontend — Vite dev server (not nginx) with HMR
  # --------------------------------------------------------------------------
  frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile
      target: development
    command: npm run dev -- --host 0.0.0.0 --port 5173
    environment:
      VITE_API_URL: http://localhost:8000/api/v1
    volumes:
      - ../../frontend/src:/app/src:cached
      - ../../frontend/public:/app/public:cached
    ports:
      - "5173:5173"

  # --------------------------------------------------------------------------
  # Nginx — Not used in dev (Vite proxies to API directly)
  # --------------------------------------------------------------------------
  nginx:
    profiles:
      - disabled
