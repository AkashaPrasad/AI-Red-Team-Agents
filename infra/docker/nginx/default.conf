# ==============================================================================
# Nginx — Server Block
# Routes: /api/* → backend, /health → backend, / → frontend
# ==============================================================================

upstream api_backend {
    server api:8000;
}

upstream frontend_app {
    server frontend:80;
}

server {
    listen 80;
    server_name _;

    # --- API Routes → Backend ---
    location /api/ {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-running experiment operations
        proxy_connect_timeout 10s;
        proxy_read_timeout 120s;
        proxy_send_timeout 30s;
    }

    # --- Health Check → Backend ---
    location /health {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
    }

    # --- Firewall Endpoint (public, latency-critical) ---
    location /api/v1/firewall/ {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Tighter timeouts for real-time firewall
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
        proxy_send_timeout 5s;
    }

    # --- Frontend SPA → React App ---
    location / {
        proxy_pass http://frontend_app;
        proxy_set_header Host $host;

        # SPA fallback: any non-file route returns index.html
        proxy_intercept_errors on;
        error_page 404 = /index.html;
    }

    # --- Static Assets (cached aggressively) ---
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://frontend_app;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
